<?php
$posts = [];
$currentHost = $_SERVER["REQUEST_SCHEME"] . "://" . $_SERVER["SERVER_NAME"] . "/";
$dir = new DirectoryIterator(realpath(__dir__ . "/../src/blog/metadata"));

foreach($dir as $fileInfo){
	if(!$fileInfo->isDot()){
		$postData = json_decode(file_get_contents($fileInfo->getPathname()), true);
		$posts[strtotime($postData["date"])] = array(
			"title" => $postData["title"],
			"description" => $postData["description"],
			"pubDate" => date("r", strtotime($postData["date"])),
			"link" => $currentHost . "blog/" . str_replace(".json", "", $fileInfo->getFilename()) . "/"
		);
	}
}

krsort($posts);

echo ("<?xml version=\"1.0\" encoding=\"utf-8\" ?>\n");
?><rss version="2.0">
	<channel>
		<title>Jeremy Wagner's Web Development Blog</title>
		<description>The web development blog of developer, author and speaker Jeremy Wagner. Occasionally strays off into non-technical (i.e., rambling) topics.</description>
		<link><?php echo($currentHost); ?></link>
		<?php
		foreach($posts as $post){
			?>
			<item>
				<title><?php echo($post["title"]); ?></title>
				<description><?php echo($post["description"]); ?></description>
				<link><?php echo($post["link"]); ?></link>
				<guid><?php echo($post["link"]); ?></guid>
				<pubDate><?php echo($post["pubDate"]); ?></pubDate>
			</item>
			<?php
		}
		?>
	</channel>
</rss>
